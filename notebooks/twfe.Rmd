---
title: "Eventstudies"
author: "Fabian Gunzinger"
date: '2022-07-21'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
library(did)
library(tidyverse)
library(fixest)
library(glue)
library(gridExtra)
library(lubridate)

source('/Users/fgu/dev/projects/mdb_eval/src/config.R')
source('/Users/fgu/dev/projects/mdb_eval/src/helpers/fixest_settings.R')
source('/Users/fgu/dev/projects/mdb_eval/src/helpers/helpers.R')
```

```{r}
df <- read_analysis_data() %>% filter(between(tt, -24, 23))
names(df)

nrow(df)
# Duplicate time to treatment variable as x for fixest indicator binning
df$x <- df$tt

# Define fixest variable macros
setFixest_fml(
  ..ds = ~i(tt, ref = -1, bin = .("-6" = ~x <= -6, "5" = ~x >= 5)),
  ..controls = ~month_income + month_spend + accounts_active,
  ..fe = ~user_id + ym,
  ..mvfe = ~mvsw(user_id, ym)
)
```



## TWFE Estimates

### Estimating average period effects.

Estimates represent average spend in each period, compared to base period (`feols` automatically drops first available period to avoid perfect multicollinearity)

```{r}
m <- feols(dspend ~ i(tt), df)
fiplot(m)
```

In what follows, we use the last pre-treatment period as the reference period, which is more natural and standard.

```{r}
m <- feols(dspend ~ i(tt, ref = -1) | user_id, df)
fiplot(m)
```


### Adding fixed effects

Adding user (or year-month) fixed effects identifies coefficients only up to a constant, since the regression equation would stay unchanged if we were to add a constant to the fixed effect and subtract the same constant from the coefficient of the period effect (see section 2.1 in schmidheiny2020event). `feols` automatically drops the constant from the model to deal with this.

```{r}
m0 <- feols(dspend ~ i(tt, ref = -1), df)
m1 <- feols(dspend ~ i(tt, ref = -1) | user_id, df)
m2 <- feols(dspend ~ i(tt, ref = -1) | ym, df)
etable(list(m0, m1, m2))
fiplot(list(m0, m1, m2))
legend("topleft", col = c(1, 2, 4), pch = c(20, 15, 17),
       legend = c("No FEs", "User FE", "Year-month FEs"))
```


### Two-way fixed effects

- Using a two-way fixed effects model (with unit and time fixed-effects) leads to the underidentificatin issue discussed in section 3.1 in borusyak2018revisiting, who demonstrate that the period effects are only identified up to a trend in time since treatment ("tt" in our case).

- Thus, in a two-way FE model we need to drop at least two period dummies for period effects to be identified.

- As borusyak2018revisiting point out in section 6.2, the choice of these periods effects the estimates and can thus produce seemingly unstable parameter estimates (estimates are actually the same up to a linear trend in tt -- they are rotated).

- To deal with this underidentification issue, `feols` automatically drops the last available period, which is 26. (We can see in the figure that both -1 and 26 are now set to 0).

```{r}
m <- feols(dspend ~ i(tt, ref = -1) | user_id + ym, df)
fiplot(m)
```

- The problem is that our choice of which additional period(s) to drop affects can change the estimates significantly, and there is no guidance as to how to choose what period(s) to exclude.

- Using schmidheiny2020event's preferred specification of binned endpoints we can see below how much the results can change.

- The specification where we bin endpoints -6 and 5 was our initial specification. The other two specifications (binning at -12 and -18 instead of at -6) are plausible alternatives that change the results.

```{r}
m1 <- feols(dspend ~ i(tt, ref = -1, bin = .("-6" = ~x <= -6, "5" = ~x >= 5)) + ..controls | user_id + ym, df)
m2 <- feols(dspend ~ i(tt, ref = -1, bin = .("-12" = ~x <= -12, "5" = ~x >= 5)) + ..controls | user_id + ym, df)
m3 <- feols(dspend ~ i(tt, ref = -1, bin = .("-18" = ~x <= -18, "5" = ~x >= 5)) + ..controls | user_id + ym, df)
fiplot(list(m3, m2, m1))
```

- If we expand lags only, the results are more stable (which makes sense, given that they are rotations of one another around the reference point).

```{r}
m1 <- feols(dspend ~ i(tt, ref = -1, bin = .("-6" = ~x <= -6, "5" = ~x >= 5)) + ..controls | user_id + ym, df)
m2 <- feols(dspend ~ i(tt, ref = -1, bin = .("-6" = ~x <= -6, "11" = ~x >= 11)) + ..controls | user_id + ym, df)
m3 <- feols(dspend ~ i(tt, ref = -1, bin = .("-6" = ~x <= -6, "17" = ~x >= 17)) + ..controls | user_id + ym, df)
fiplot(list(m3, m2, m1))
etable(list(m3, m2, m1))
```

- The main insight from the graphs above is that estimates are rotations around the reference point. Two corollaries that are visible from the figures are that (1) keeping leads binning point unchanged and expanding lags largely preserves results, and (2) it's the location of the leftmost bin that changes results -- hence, if that bin is equal, as is the case for -18 and -12 above, results are very similar, too.


## Additional topics

### Using calendar month

- If month seasonality is constant across year, we could use month fixed effects instead of ym fixed effects and solve the above problem.

- This works, but is not valid since there are clear year level-effects in the seasonality pattern.

```{r}
m1 <- feols(dspend ~ i(tt, ref = -1, bin = .("-6" = ~x <= -6, "5" = ~x >= 5)) + ..controls | user_id + month, df)
m2 <- feols(dspend ~ i(tt, ref = -1, bin = .("-12" = ~x <= -12, "11" = ~x >= 11)) + ..controls | user_id + month, df)
m3 <- feols(dspend ~ i(tt, ref = -1, bin = .("-18" = ~x <= -18, "17" = ~x >= 17)) + ..controls | user_id + month, df)
iplot(list(m3, m2, m1))
etable(list(m3, m2, m1))
```


```{r}
df %>% 
  mutate(year = substr(ymn, 1, 4)) %>% 
  group_by(month, year) %>% 
  summarise(dspend = mean(dspend)) %>% 
  ggplot(aes(month, dspend, colour = year)) +
  geom_line() +
  geom_point()
```


### Explaining overall shape

- Overall shape closely resembles that of average number of active accounts.

```{r}
df %>% 
  group_by(tt) %>% 
  summarise(y = mean(accounts_active)) %>% 
  ggplot(aes(tt, y)) +
  geom_line() +
  geom_point()
```


```{r}
# m0 <- feols(dspend ~ i(tt), df)
m1 <- feols(dspend ~ i(tt), df)
# m2 <- feols(dspend ~ i(tt) | user_id, df)
m3 <- feols(dspend ~ i(tt) | user_id, df)

# m2 <- feols(dspend ~ i(tt) | ym, df)

fiplot(m3)
legend("topleft", col = c(1, 2, 4), pch = c(20, 15, 17),
       legend = c("Between estimator", "Within estimator"))
```



## Why is there such a drop for leads 11 and higher once we add user FE?

- There is a level shift for leads 11 and higher once we add user fixed effects. Below we reproduce the above above two plots in the same figure to see this more clearly.

```{r}
m1 <- feols(dspend ~ -1 + i(tt), df)
m2 <- feols(dspend ~ -1 + i(tt) | user_id, df)
fiplot(list(m1, m2))
legend("bottomleft", col = c(1, 2), pch = c(20, 15), legend = c("No FEs", "FEs"))
```

- What happens here?

- I'm controlling for number of cards in the main specification, but it seems unlikely that the shape of the results would be so similar to that of number of cards in the raw data.

